<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://tonejs.github.io/build/Tone.js"></script>
<button>start</button>
<script>
  /* global nn, Tone */
  let canvas, ctx
  const rad = 75
  
  // ratios of intrvals for just intonation instead of equal tempermant
  const ratios = [1, 1.125, 1.25, 4 / 3, 1.5, 5 / 3, 15 / 8, 2, 2.5, 8 / 3, 3, 10 / 3, 15 / 4]

  const pluck = new Tone.PluckSynth().toDestination()
  const poly = new Tone.PolySynth().toDestination()
  const synth = new Tone.Synth().toDestination()

  const tonic = nn.randomInt(200, 400)
  let step = 0

  function play_chord(time) {
    const i = nn.randomInt(0, 6)
    let chord = [ratios[i] * tonic, ratios[i + 2] * tonic / 2, ratios [i + 4] * tonic / 2]
    if (Math.random() > 0.5){
      chord.push(tonic * ratios[i + 6] / 2)
    }
    synth.triggerAttackRelease(chord[0] / 8, '1n', time)
    poly.triggerAttackRelease(chord, '1n', time, 0.2)
  }

  function play_note(time) {
    const note_pos = Math.random(ratios)
    const note = tonic * note_pos
    pluck.triggerAttackRelease(note, '8n', time)
  }
  
   function draw(step){
     
    ctx.fillStyle = `rgb(${nn.randomInt(0, 255)}, ${nn.randomInt(0, 255)}, ${nn.randomInt(0, 255)})`
    ctx.fillRect(0, 0, nn.width, nn.height)
         ctx.beginPath()

     ctx.arc(nn.width / 2, nn.height / 2, rad, 0, 2 * Math.PI())
     
     ctx.stroke()
  }

  function play(time) {
    if (step % 8 === 0){
      play_chord(time)}
    if (Math.random() > 0.7) {
      play_note(time)
    }
    draw(step)
    step++
  }
  
 

  function toggle() {
    if (Tone.Transport.state === 'started') {
      Tone.Transport.stop()
      nn.get('button').content('start')
    } else {
      Tone.Transport.start()
      nn.get('button').content('stop')
    }
  }
  
  function setup(){
    canvas = nn.create('canvas').addTo('body')
    canvas.width = nn.width
    canvas.height = nn.height
    ctx = canvas.getContext('2d')
    
      nn.get('button').on('click', toggle)
      Tone.Transport.bpm.value = nn.randomInt(70, 150)
      Tone.Transport.scheduleRepeat(time => play(time), '8n')
  }

  nn.on('load', setup)
  
</script>